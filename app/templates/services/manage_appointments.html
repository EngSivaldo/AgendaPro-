{% extends "base.html" %}

{% block content %}
<h1 class="mt-4"><i class="fas fa-calendar-day me-2 text-warning"></i> Gerenciar Todos os Agendamentos</h1>
<p class="text-muted">Vis√£o geral e controle total sobre a agenda da cl√≠nica. Total de Agendamentos: **{{ appointments | length }}**</p>

<div class="table-responsive">
    <table class="table table-striped table-hover align-middle table-sm">
        <thead>
            <tr class="table-dark">
                <th style="width: 5%;">#ID</th>
                <th style="width: 15%;">Cliente</th>
                <th style="width: 15%;">Servi√ßo & Pre√ßo</th>
                <th style="width: 18%;">Data e Hora</th>
                <th style="width: 12%;">Status</th>
                <th class="text-center" style="width: 18%;">Atualizar Status</th>
                <th class="text-center" style="width: 17%;">Reagendar</th>
            </tr>
        </thead>
        <tbody>
            {% for appointment in appointments %}
            
            {% set appt_passed = appointment.data_horario < now() %}
            
            <tr>
                {# COLUNA ID #}
                <td class="text-center">{{ appointment.id }}</td>
                
                {# COLUNA CLIENTE #}
                <td>
                    <i class="fas fa-user me-1 text-primary"></i> **{{ appointment.user.nome }}**<br>
                    <small class="text-muted">{{ appointment.user.email }}</small>
                </td>
                
                {# COLUNA SERVI√áO #}
                <td>
                    {{ appointment.servico.nome }}<br>
                    <small class="text-success fw-bold">R$ {{ "%.2f"|format(appointment.servico.preco) }} ({{ appointment.servico.duracao_minutos }} min)</small>
                </td>
                
                {# COLUNA DATA E HORA #}
                <td>
                    <i class="fas fa-calendar-alt me-1 text-info"></i> 
                    **{{ appointment.data_horario.strftime('%d/%m/%Y') }}**
                    √†s <span class="fw-bold text-dark">{{ appointment.data_horario.strftime('%H:%M') }}</span>
                </td>
                
                {# COLUNA STATUS #}
                <td>
                    {% if appointment.status == 'Agendado' %}
                        {% if appt_passed %}
                             <span class="badge bg-danger">Atrasado/Pendente</span>
                        {% else %}
                             <span class="badge bg-success">Agendado</span>
                        {% endif %}
                    {% elif appointment.status == 'Conclu√≠do' %}
                        <span class="badge bg-primary">Conclu√≠do</span>
                    {% elif appointment.status == 'Cancelado' %}
                        <span class="badge bg-secondary">Cancelado</span>
                    {% elif appointment.status == 'Reagendado' %}
                        <span class="badge bg-warning text-dark">Reagendado</span>
                    {% else %}
                        <span class="badge bg-info">{{ appointment.status }}</span>
                    {% endif %}
                </td>
                
                {# ---------------------------------------------------- #}
                {# üìå COLUNA 1: ATUALIZAR STATUS #}
                {# ---------------------------------------------------- #}
                <td>
                    {% if appointment.status != 'Cancelado' and appointment.status != 'Conclu√≠do' %}
                    <form method="POST" 
                          action="{{ url_for('services.update_appointment_status', appointment_id=appointment.id) }}" 
                          class="input-group input-group-sm"
                          onsubmit="return handleStatusChange(this);">
                        
                        <select name="status" class="form-select" data-bs-toggle="tooltip" title="Altera o estado do agendamento.">
                            <option value="" disabled selected>Mudar para...</option>
                            <option value="Conclu√≠do">Conclu√≠do</option>
                            <option value="Cancelado">Cancelar</option>
                            <option value="Agendado">Voltar p/ Agendado</option>
                        </select>
                        
                        <button type="submit" class="btn btn-primary" data-bs-toggle="tooltip" title="Salvar novo status">
                            <i class="fas fa-check"></i> Salvar
                        </button>
                    </form>
                    {% else %}
                        <small class="text-secondary">Status Finalizado/Cancelado</small>
                    {% endif %}
                </td>

                {# ---------------------------------------------------- #}
                {# üìå COLUNA 2: REAGENDAR #}
                {# ---------------------------------------------------- #}
                <td>
                    {% if appointment.status != 'Conclu√≠do' and not appt_passed %} 
                    <form method="POST" action="{{ url_for('services.reschedule_appointment', appointment_id=appointment.id) }}" class="input-group input-group-sm">
                        
                        {# Preenche o campo com a data/hora atual do agendamento #}
                        <input type="datetime-local" 
                               name="new_datetime" 
                               class="form-control" 
                               required
                               data-bs-toggle="tooltip" title="Nova data e hora para o reagendamento."
                               value="{{ appointment.data_horario.strftime('%Y-%m-%dT%H:%M') }}"
                               min="{{ now().strftime('%Y-%m-%dT%H:%M') }}">
                        
                        <button type="submit" class="btn btn-warning text-dark" data-bs-toggle="tooltip" title="Reagendar e notificar cliente">
                            <i class="fas fa-redo-alt"></i> Reagendar
                        </button>
                    </form>
                    {% else %}
                        <small class="text-secondary">A√ß√£o indispon√≠vel</small>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" class="text-center py-4">
                    <i class="fas fa-exclamation-triangle me-2 text-danger"></i> Nenhum agendamento encontrado no sistema.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // 1. Confirma√ß√£o JavaScript para Cancelamento (Seguran√ßa UX)
    function handleStatusChange(form) {
        var statusSelect = form.querySelector('select[name="status"]');
        var newStatus = statusSelect.value;
        
        if (newStatus === 'Cancelado') {
            return confirm('ATEN√á√ÉO: Voc√™ tem certeza que deseja CANCELAR este agendamento? O cliente ser√° notificado por e-mail.');
        }

        if (newStatus === '') {
            alert('Por favor, selecione um status para atualizar.');
            return false;
        }

        return true;
    }

    // 2. Ativa√ß√£o dos Tooltips do Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })
</script>
{% endblock %}