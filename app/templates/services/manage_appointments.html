{% extends "base.html" %}

{% block content %}
<h1 class="mt-4">üìã Gerenciar Agendamentos</h1>
<p class="mb-4">Visualiza√ß√£o de todos os agendamentos do sistema.</p>

{% if appointments %}
<div class="row">
    {% for appointment in appointments %}
    {% set current_status = appointment.status %}
    
    <div class="col-md-6 mb-4">
        <div class="card 
            {% if current_status == 'Cancelado' %}border-secondary
            {% elif current_status == 'Conclu√≠do' %}border-primary
            {% elif appointment.data_horario < now() and current_status == 'Agendado' %}border-danger
            {% else %}border-success
            {% endif %}">
            
            <div class="card-header bg-light">
                <strong>Agendamento #{{ appointment.id }}</strong>
            </div>
            
            <div class="card-body">
                <h5 class="card-title">{{ appointment.servico.nome }}</h5>
                <p class="card-text">
                    <strong>Cliente:</strong> <strong>{{ appointment.user.nome }}</strong> (ID: {{ appointment.user.id }})<br>
                    <strong>Data/Hora:</strong> <strong>{{ appointment.data_horario.strftime('%d/%m/%Y √†s %H:%M') }}</strong><br>
                    <strong>Dura√ß√£o:</strong> {{ appointment.servico.duracao_minutos }} minutos<br>
                    <strong>Pre√ßo:</strong> R$ {{ "%.2f"|format(appointment.servico.preco) }}
                </p>

                <hr>

                <h6 class="mt-3">Reagendar (Nova Data):</h6>
                <form method="POST" action="{{ url_for('services.reschedule_appointment', appointment_id=appointment.id) }}" 
                    style="display: flex; align-items: center; gap: 5px; margin-bottom: 15px;"
                    onsubmit="return confirm('Confirmar reagendamento de {{ appointment.servico.nome }} para a nova data?');">
                    
                    <input type="datetime-local" 
                           name="new_datetime" 
                           class="form-control form-control-sm" 
                           required 
                           style="max-width: 200px;">
                    
                    <button type="submit" class="btn btn-sm btn-info" title="Reagendar">
                        <i class="fas fa-calendar-alt"></i> Reagendar
                    </button>
                </form>
                
                <hr>

                <h6 class="mt-3">Mudar Status (Atual: 
                    <span class="badge 
                        {% if current_status == 'Cancelado' %}bg-danger
                        {% elif current_status == 'Conclu√≠do' or current_status == 'Reagendado' %}bg-primary
                        {% else %}bg-success{% endif %}">
                        {{ current_status }}
                    </span>
                    ):
                </h6>
                <form method="POST" action="{{ url_for('services.update_appointment_status', appointment_id=appointment.id) }}" 
                    style="display: flex; align-items: center; gap: 5px;">
                    
                    <select name="status" class="form-select form-select-sm" style="min-width: 130px;">
                        
                        <option value="Agendado" {% if current_status == 'Agendado' %}selected{% endif %}>Agendado</option>
                        <option value="Conclu√≠do" {% if current_status == 'Conclu√≠do' %}selected{% endif %}>Conclu√≠do</option>
                        <option value="Cancelado" {% if current_status == 'Cancelado' %}selected{% endif %}>Cancelado</option>
                        
                        </select>
                    
                    <button type="submit" class="btn btn-sm btn-success" title="Salvar Status">
                        <i class="fas fa-sync-alt"></i> Salvar
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="alert alert-info">
    Ainda n√£o h√° agendamentos registrados no sistema.
</div>
{% endif %}
{% endblock %}