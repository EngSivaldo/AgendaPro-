{% extends "base.html" %}

{% block content %}

<style>
    /* Estilos Espec√≠ficos para a Tabela de Agendamentos */
    
    /* T√≠tulo Principal */
    .schedule-header h1 {
        font-weight: 800;
        color: var(--dark-navy) !important;
        letter-spacing: 0.5px;
    }
    .schedule-header h1 i {
        color: var(--primary-teal); /* √çcone principal em Teal */
    }

    /* Tabela Customizada (Mais limpa e com bordas) */
    .table-schedule {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    .table-schedule thead tr {
        background-color: var(--dark-navy);
        color: var(--text-on-dark);
        font-weight: 600;
        border-top: 3px solid var(--accent-pink); /* Linha de destaque */
    }
    .table-schedule tbody tr:hover {
        background-color: #f7f9fb; /* Hover sutil */
    }
    
    /* Estilos para a Coluna de Status */
    .status-badge {
        font-size: 0.85rem;
        font-weight: 600;
        padding: 0.4em 0.7em;
        border-radius: 50px;
        min-width: 90px;
        display: inline-block;
        text-align: center;
    }
    .bg-scheduled { background-color: var(--primary-teal); color: white; }
    .bg-late { background-color: var(--accent-pink); color: white; }
    .bg-completed { background-color: var(--dark-navy); color: white; }
    .bg-cancelled { background-color: #7994A8; color: white; } /* Cinza neutro */
    .bg-rescheduled { background-color: #f0ad4e; color: var(--dark-navy); } /* Amarelo Bootstrap */


    /* A√ß√µes de Formul√°rio (input-group) */
    .input-group-sm .form-select {
        border-radius: 50px 0 0 50px;
        font-size: 0.8rem;
    }
    .input-group-sm .btn {
        border-radius: 0 50px 50px 0;
        font-size: 0.8rem;
        padding: 0.35rem 0.75rem;
    }
    
    /* Bot√µes de A√ß√£o Espec√≠ficos */
    .btn-save-status {
        background-color: var(--primary-teal) !important;
        border-color: var(--primary-teal) !important;
    }
    .btn-reschedule {
        background-color: var(--accent-pink) !important;
        border-color: var(--accent-pink) !important;
        color: white !important;
    }
    
    /* Campo de Data/Hora (para ser discreto, mas funcional) */
    input[type="datetime-local"] {
        font-size: 0.8rem;
        border-radius: 50px 0 0 50px !important;
    }

    .row-disabled {
        opacity: 0.6; /* Diminui a opacidade para itens conclu√≠dos/cancelados */
    }
</style>

<div class="schedule-header mt-4 mb-4">
    <h1 class="display-5"><i class="fas fa-calendar-day me-2"></i> Gerenciar Todos os Agendamentos</h1>
    <p class="lead" style="color: var(--text-default);">Vis√£o geral e controle total sobre a agenda. Total de Agendamentos: <span class="fw-bold" style="color: var(--accent-pink);">{{ appointments | length }}</span></p>
</div>

<div class="table-responsive table-schedule">
    <table class="table table-striped table-hover align-middle table-sm mb-0">
        <thead>
            <tr>
                <th class="text-center" style="width: 5%;">#ID</th>
                <th style="width: 15%;">Cliente</th>
                <th style="width: 15%;">Servi√ßo & Pre√ßo</th>
                <th style="width: 18%;">Data e Hora</th>
                <th class="text-center" style="width: 12%;">Status</th>
                <th class="text-center" style="width: 18%;">Atualizar Status</th>
                <th class="text-center" style="width: 17%;">Reagendar</th>
            </tr>
        </thead>
        <tbody>
            {% for appointment in appointments %}
            
            {# Vari√°veis para status visual #}
            {% set appt_passed = appointment.data_horario < now() %}
            {% set row_class = 'row-disabled' if appointment.status == 'Conclu√≠do' or appointment.status == 'Cancelado' %}
            
            <tr class="{{ row_class }}">
                {# COLUNA ID #}
                <td class="text-center text-muted">{{ appointment.id }}</td>
                
                {# COLUNA CLIENTE #}
                <td>
                    <i class="fas fa-user me-1" style="color: var(--primary-teal);"></i> <strong style="color: var(--dark-navy);">{{ appointment.user.nome }}</strong><br>
                    <small class="text-muted">{{ appointment.user.email }}</small>
                </td>
                
                {# COLUNA SERVI√áO #}
                <td>
                    {{ appointment.servico.nome }}<br>
                    <small class="fw-bold" style="color: var(--accent-pink);">R$ {{ "%.2f"|format(appointment.servico.preco) }}</small>
                </td>
                
                {# COLUNA DATA E HORA #}
                <td>
                    <i class="fas fa-clock me-1" style="color: var(--dark-navy);"></i> 
                    **{{ appointment.data_horario.strftime('%d/%m/%Y') }}**
                    √†s <span class="fw-bold" style="color: var(--primary-teal);">{{ appointment.data_horario.strftime('%H:%M') }}</span>
                </td>
                
                {# COLUNA STATUS #}
                <td class="text-center">
                    {% if appointment.status == 'Agendado' %}
                        {% if appt_passed %}
                             <span class="badge status-badge bg-late">Atrasado</span>
                        {% else %}
                             <span class="badge status-badge bg-scheduled">Agendado</span>
                        {% endif %}
                    {% elif appointment.status == 'Conclu√≠do' %}
                        <span class="badge status-badge bg-completed">Conclu√≠do</span>
                    {% elif appointment.status == 'Cancelado' %}
                        <span class="badge status-badge bg-cancelled">Cancelado</span>
                    {% elif appointment.status == 'Reagendado' %}
                        <span class="badge status-badge bg-rescheduled">Reagendado</span>
                    {% else %}
                        <span class="badge status-badge bg-info">{{ appointment.status }}</span>
                    {% endif %}
                </td>
                
                {# ---------------------------------------------------- #}
                {# üìå COLUNA 1: ATUALIZAR STATUS #}
                {# ---------------------------------------------------- #}
                <td>
                    {% if appointment.status != 'Cancelado' and appointment.status != 'Conclu√≠do' %}
                    <form method="POST" 
                          action="{{ url_for('admin.update_appointment_status', appointment_id=appointment.id) }}" 
                          class="input-group input-group-sm"
                          onsubmit="return handleStatusChange(this);">
                        
                        <select name="status" class="form-select" data-bs-toggle="tooltip" title="Altera o estado do agendamento.">
                            <option value="" disabled selected>Mudar para...</option>
                            <option value="Conclu√≠do">Conclu√≠do</option>
                            <option value="Cancelado">Cancelar</option>
                            <option value="Agendado">Voltar p/ Agendado</option>
                        </select>
                        
                        <button type="submit" class="btn btn-save-status" data-bs-toggle="tooltip" title="Salvar novo status">
                            <i class="fas fa-check"></i>
                        </button>
                    </form>
                    {% else %}
                        <small class="text-secondary">A√ß√£o n√£o permitida.</small>
                    {% endif %}
                </td>

                {# ---------------------------------------------------- #}
                {# üìå COLUNA 2: REAGENDAR #}
                {# ---------------------------------------------------- #}
                <td>
                    {% if appointment.status != 'Conclu√≠do' and not appt_passed %} 
                    <form method="POST" action="{{ url_for('admin.reschedule_appointment', appointment_id=appointment.id) }}" class="input-group input-group-sm">
                        
                        <input type="datetime-local" 
                               name="new_datetime" 
                               class="form-control" 
                               required
                               data-bs-toggle="tooltip" title="Nova data e hora."
                               value="{{ appointment.data_horario.strftime('%Y-%m-%dT%H:%M') }}"
                               min="{{ now().strftime('%Y-%m-%dT%H:%M') }}">
                        
                        <button type="submit" class="btn btn-reschedule" data-bs-toggle="tooltip" title="Reagendar e notificar cliente">
                            <i class="fas fa-redo-alt"></i>
                        </button>
                    </form>
                    {% else %}
                        <small class="text-secondary">A√ß√£o indispon√≠vel.</small>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" class="text-center py-5">
                    <div class="alert alert-warning border-warning fw-bold mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i> Nenhum agendamento encontrado no sistema.
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // 1. Confirma√ß√£o JavaScript para Cancelamento (Seguran√ßa UX)
    function handleStatusChange(form) {
        var statusSelect = form.querySelector('select[name="status"]');
        var newStatus = statusSelect.value;
        
        if (newStatus === 'Cancelado') {
            return confirm('ATEN√á√ÉO: Voc√™ tem certeza que deseja CANCELAR este agendamento? O cliente ser√° notificado por e-mail.');
        }

        if (newStatus === '') {
            alert('Por favor, selecione um status para atualizar.');
            return false;
        }

        return true;
    }

    // 2. Ativa√ß√£o dos Tooltips do Bootstrap
    document.addEventListener('DOMContentLoaded', function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    });
</script>
{% endblock %}