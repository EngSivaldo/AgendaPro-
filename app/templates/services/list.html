{% extends "base.html" %}

{% block content %}

<style>
    /* Estilos Espec√≠ficos para a Listagem de Servi√ßos */
    
    /* T√≠tulo Principal */
    .services-header h1 {
        font-weight: 800;
        color: var(--dark-navy) !important;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }
    .services-header h1 i {
        color: var(--primary-teal); /* √çcone principal em Teal */
    }

    /* Bot√£o de A√ß√£o Principal (Adicionar Novo Servi√ßo) */
    .btn-add-service {
        background-color: var(--accent-pink);
        border-color: var(--accent-pink);
        color: white;
        font-weight: 700;
        border-radius: 50px; /* Pilular */
        padding: 0.6rem 1.5rem;
        box-shadow: 0 4px 10px rgba(255, 107, 129, 0.4);
        transition: all 0.2s ease-in-out;
    }
    .btn-add-service:hover {
        background-color: #f75c70;
        border-color: #f75c70;
        transform: translateY(-1px);
    }

    /* Tabela Customizada (Mais limpa) */
    .table-custom {
        border-radius: 12px;
        overflow: hidden; /* Garante que o rounded corner funcione com o thead */
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    .table-custom thead tr {
        background-color: var(--dark-navy);
        color: var(--text-on-dark);
        font-weight: 600;
    }
    .table-custom tbody tr:hover {
        background-color: #f7f9fb; /* Hover sutil no corpo */
    }
    
    /* Estilo para Pre√ßo */
    .service-price {
        font-weight: 700;
        color: var(--dark-navy);
    }
    
    /* Bot√µes de A√ß√£o na Tabela */
    .btn-edit-teal {
        background-color: var(--primary-teal);
        border-color: var(--primary-teal);
        color: white;
        transition: all 0.2s;
    }
    .btn-edit-teal:hover {
        background-color: #00A396;
        border-color: #00A396;
    }

    .btn-delete-pink {
        background-color: var(--accent-pink);
        border-color: var(--accent-pink);
        color: white;
        transition: all 0.2s;
    }
    .btn-delete-pink:hover {
        background-color: #E65A70;
        border-color: #E65A70;
    }
</style>

<div class="services-header mt-4 mb-4">
    <h1 class="display-5"><i class="fas fa-tags me-2"></i> Gerenciamento de Servi√ßos</h1>
    <p class="lead" style="color: var(--text-default);">Defina os pre√ßos, dura√ß√£o e descri√ß√£o dos servi√ßos dispon√≠veis para agendamento.</p>
</div>

<div class="mb-4">
    <a href="{{ url_for('admin.create_service') }}" class="btn btn-add-service">
        <i class="fas fa-plus-circle me-1"></i> Adicionar Novo Servi√ßo
    </a>
</div>

<div class="table-responsive table-custom">
    <table class="table table-striped table-hover align-middle mb-0">
        <thead>
            <tr>
                <th>Nome</th>
                <th class="text-end">Pre√ßo</th>
                <th class="text-center">Dura√ß√£o (min)</th>
                <th>Descri√ß√£o</th>
                <th class="text-center">A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for service in services %}
            <tr>
                <td><strong style="color: var(--dark-navy);">{{ service.nome }}</strong></td>
                <td class="text-end service-price">R$ {{ "%.2f"|format(service.preco) }}</td>
                <td class="text-center">{{ service.duracao_minutos }}</td>
                <td>
                    {# Mostra status de Inativo se for o caso. Adicionado classe para manipula√ß√£o via JS #}
                    {% if not service.is_active %}
                        <span class="badge bg-secondary me-2 service-inactive-badge">INATIVO</span>
                    {% endif %}
                    {{ service.descricao or '<span class="text-muted fst-italic">Sem descri√ß√£o</span>' | safe }}
                </td>
                <td class="text-center">
                    <div class="d-flex justify-content-center gap-2">
                        
                        {# 1. Bot√£o Editar (A√ß√£o GET) #}
                        <a href="{{ url_for('admin.edit_service', service_id=service.id) }}" class="btn btn-sm btn-edit-teal">
                            <i class="fas fa-edit"></i> Editar
                        </a>
                        
                        {# 2. Bot√£o de Toggle (AJAX) #}
                        <button type="button" 
                                class="btn btn-sm toggle-service-btn {% if service.is_active %}btn-delete-pink{% else %}btn-success{% endif %}"
                                data-service-id="{{ service.id }}" 
                                data-is-active="{{ service.is_active | tojson }}"
                                data-active-text="Desativar" 
                                data-inactive-text="Ativar">
                            
                            {% if service.is_active %}
                                <i class="fas fa-toggle-off"></i> Desativar
                            {% else %}
                                <i class="fas fa-toggle-on"></i> Ativar
                            {% endif %}
                        </button>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" class="text-center p-4">
                    <div class="alert alert-info fw-bold mb-0">
                        <i class="fas fa-info-circle me-2"></i> Nenhum servi√ßo cadastrado ainda. Use o bot√£o acima para come√ßar.
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %} 

{# ---------------------------------------------------------------------------------- #}
{# BLOCO DE SCRIPTS (Corrigido para AJAX Puro e robustez de eventos) #}
{# ---------------------------------------------------------------------------------- #}
{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleButtons = document.querySelectorAll('.toggle-service-btn');

    toggleButtons.forEach(button => {
        
        // üö® NOVIDADE: Remove listeners anteriores para evitar duplica√ß√£o em Hot Reloading
        // O `null` aqui indica que remover√° qualquer listener do tipo 'click' (funciona em alguns ambientes)
        button.removeEventListener('click', null); 

        button.addEventListener('click', function() {
            
            const serviceId = this.getAttribute('data-service-id');
            
            // Leitura robusta do estado: Converte para min√∫sculas para comparar com 'true'
            const isActive = this.getAttribute('data-is-active').toLowerCase() === 'true'; 
            
            const nomeServico = this.closest('tr').querySelector('strong').textContent.trim();
            const actionText = isActive ? 'desativar' : 'ativar';

            const confirmationMessage = `Tem certeza que deseja ${actionText} o servi√ßo ${nomeServico}?`;

            if (!confirm(confirmationMessage)) {
                return; 
            }

            const url = `{{ url_for('admin.toggle_service_active', service_id=0) }}`.replace('0', serviceId);
            const originalHtml = this.innerHTML; // Salva o HTML original

            // Feedback Visual: Bloqueia o bot√£o e mostra processando
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processando...';
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest' 
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { 
                        throw new Error(err.message || `Erro do Servidor: ${response.status}`); 
                    });
                }
                return response.json(); 
            })
            .then(data => {
                if (data.success) {
                    const finalStatus = data.new_status; 

                    // 1. ATUALIZA O ESTADO (Sincroniza o DOM com o Back-End)
                    this.setAttribute('data-is-active', finalStatus.toString()); 

                    // 2. Localiza e manipula o badge INATIVO
                    const descriptionCell = this.closest('tr').children[3];
                    let badge = descriptionCell.querySelector('.service-inactive-badge');

                    // 3. Atualiza o bot√£o (Cor e Texto)
                    // ... (dentro do .then(data => { ... )

    // 3. Atualiza o bot√£o (Cor e Texto)
    // Se o status FINAL for TRUE (ATIVADO)
    if (finalStatus) { 
        // ‚û°Ô∏è O bot√£o AGORA deve dizer DESATIVAR e ser ROSA
        this.classList.remove('btn-success'); // Remove a cor de Ativar
        this.classList.add('btn-delete-pink'); // Adiciona a cor de Desativar
        this.innerHTML = `<i class="fas fa-toggle-off"></i> ${this.getAttribute('data-active-text')}`; // Texto: Desativar
        
        // Remove o badge INATIVO
        if (badge) {
            badge.remove();
        }
    } else { // Se o status FINAL for FALSE (DESATIVADO)
        // ‚û°Ô∏è O bot√£o AGORA deve dizer ATIVAR e ser VERDE
        this.classList.remove('btn-delete-pink'); // Remove a cor de Desativar
        this.classList.add('btn-success'); // Adiciona a cor de Ativar
        this.innerHTML = `<i class="fas fa-toggle-on"></i> ${this.getAttribute('data-inactive-text')}`; // Texto: Ativar
        
        // Adiciona o badge INATIVO
        if (!badge) {
             const newBadge = document.createElement('span');
             newBadge.className = 'badge bg-secondary me-2 service-inactive-badge';
             newBadge.textContent = 'INATIVO';
             descriptionCell.prepend(newBadge); 
        }
    }
    
    // ... (restante do c√≥digo) ...
                    
                    alert(`Sucesso: ${data.message}`);

                } else {
                    throw new Error(data.message || 'Erro desconhecido ao processar a resposta.');
                }
                
                this.disabled = false; // Reativa o bot√£o em sucesso
            })
            .catch(error => {
                console.error('Erro na altera√ß√£o de status:', error);
                alert(`ERRO: ${error.message}`);
                
                // Reverte estado visual em caso de falha
                this.disabled = false;
                this.innerHTML = originalHtml; 
            });
        });
    });
});
</script>
{% endblock %}